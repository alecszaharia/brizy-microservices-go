name: CI Status

on:
  workflow_run:
    workflows:
      - "Contracts Validation"
      - "Go Linting"
      - "Service Testing"
      - "Service Build"
    types:
      - completed

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.workflow_run.conclusion != 'cancelled'

    steps:
      - name: Check workflow status
        run: |
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Status: ${{ github.event.workflow_run.conclusion }}"
          echo "Event: ${{ github.event.workflow_run.event }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo ""

          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "✓ ${{ github.event.workflow_run.name }} completed successfully"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "skipped" ]]; then
            echo "⊘ ${{ github.event.workflow_run.name }} was skipped"
          else
            echo "❌ ${{ github.event.workflow_run.name }} failed"
            exit 1
          fi

      - name: Download artifacts
        if: github.event.workflow_run.name == 'Service Testing' && github.event.workflow_run.conclusion == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display coverage summary
        if: github.event.workflow_run.name == 'Service Testing' && github.event.workflow_run.conclusion == 'success'
        run: |
          echo ""
          echo "Coverage Summary"
          echo "================"
          for report in coverage-reports/coverage-*/coverage.out; do
            if [ -f "$report" ]; then
              service=$(basename $(dirname "$report") | sed 's/coverage-//')
              echo ""
              echo "Service: $service"
              echo "Coverage report available as artifact: coverage-$service"
            fi
          done
          echo ""
