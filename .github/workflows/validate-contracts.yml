name: Validate Contracts

on:
  pull_request:
    branches: ['**']
    paths:
      - 'api/**/*.proto'
      - 'buf.yaml'
      - 'buf.gen.yaml'
      - 'contracts/**'
      - '.github/workflows/validate-contracts.yml'
  workflow_dispatch:

# Read-only permissions for security
permissions:
  contents: read

jobs:
  validate:
    name: Validate Contracts and Service Isolation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for accurate git diff
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          # Enable built-in caching for Go modules and build cache
          cache: true
          cache-dependency-path: |
            go.work.sum
            contracts/go.sum

      - name: Setup buf CLI
        uses: bufbuild/buf-action@v1
        with:
          # Use latest stable buf version
          setup_only: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install protoc-gen-go-http
        run: |
          # Install Kratos HTTP binding generator (local plugin required by buf.gen.yaml)
          go install github.com/go-kratos/kratos/cmd/protoc-gen-go-http/v2@latest

          # Verify installation
          which protoc-gen-go-http
          protoc-gen-go-http --version || echo "protoc-gen-go-http installed"

      - name: Install buf dependencies
        run: |
          # Download buf module dependencies (googleapis, protoc-gen-validate)
          buf dep update

      - name: Generate contracts
        run: make contracts-generate

      - name: Validate service isolation
        run: |
          # Ensure script is executable
          chmod +x ./.github/scripts/validate-service-isolation.sh

          # Run validation script
          # Enforces: services must not import from each other
          # Valid imports: contracts, platform, stdlib, external dependencies
          ./.github/scripts/validate-service-isolation.sh

      - name: Check for uncommitted changes
        run: |
          # Check if contract generation produced any changes
          if ! git diff --exit-code contracts/; then
            echo "========================================="
            echo "ERROR: Uncommitted contract changes detected!"
            echo "========================================="
            echo ""
            echo "The generated contracts are out of sync with the proto files."
            echo ""
            echo "Changes detected:"
            git diff --stat contracts/
            echo ""
            echo "To fix this issue:"
            echo "  1. Run 'make contracts-generate' locally"
            echo "  2. Commit the generated files"
            echo "  3. Push the changes"
            echo ""
            echo "Diff details:"
            git diff contracts/
            exit 1
          fi

          echo "âœ“ All contracts are properly generated and committed"
